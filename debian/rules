#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

include /usr/share/dpatch/dpatch.make

# some default definitions, important!
#
# Name of the source package
psource:=virtualbox-ose-source
gsource:=virtualbox-ose-guest-source

# The short upstream name, used for the module source directory
sname:=virtualbox-ose
gname:=virtualbox-ose-guest
uname:=virtualbox-ose-guest-utils

MAKE:=kmk

env.sh: patch-stamp
	dh_testdir
	./configure --with-linux="/usr" --disable-kmods

build: build-stamp
build-stamp: env.sh
	dh_testdir

	# Building package
	$(MAKE) \
		BUILD_TYPE=release \
		PATH_OUT=$(abspath out)
	# make sure VBoxAddIF.sh is built, too
	$(MAKE) -C src/VBox/Installer/linux $(abspath out/bin/VBoxAddIF.sh) \
		PATH_OUT=$(abspath out)

	touch build-stamp

clean: unpatch
	dh_testdir
	dh_testroot

	# Cleaning package
	rm -rf out
	rm -f AutoConfig.kmk configure.log env.sh debian/$(sname).init

	dh_clean

#Rebuild the orig.tar.gz
#Please note: you can't execute this as debian/rules dfsg-free
#this won't work.
#This should be only a simple docu what to remove and what to do
#in order to repack the orig tarball.
dfsg-free:
	rm -rf ./kBuild
	rm -rf ./tools
	rm -rf ./src/VBox/Additions/os2
	rm -rf ./src/VBox/Additions/WINNT
	rm -f ./src/VBox/HostDrivers/VBoxTAP/VBoxTAP.rc
	rm -f ./src/VBox/HostDrivers/Support/darwin/load.sh
	rm -f ./include/VBox/VBoxGuest.inc
	rm -f ./include/VBox/VBoxGuest16.h
	rm -f ./include/VBox/VBoxGuest.mac
	rm -f ./src/libs/xpcom18a4/xpcom/MoreFiles/FSCopyObject.c
	rm -f ./src/libs/xpcom18a4/xpcom/MoreFiles/FSCopyObject.h
	rm -rf ./debian/
	find . -type d -name '.svn' | xargs rm -rf;
	cd .. && mv VirtualBox-1.5.2_OSE virtualbox-ose-1.5.2-dfsg2 && \
		tar cfz virtualbox-ose_1.5.2-dfsg2.orig.tar.gz virtualbox-ose-1.5.2-dfsg2

# install: DH_OPTIONS=
install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs

	# This will get installed into the package by dh_installinit
	install -m 644 src/VBox/Installer/linux/vboxnet.sh debian/$(sname).init

	# Install virtualbox guest additions
	install -m 644 out/bin/additions/vboxvideo_drv_14.so debian/$(uname)/usr/lib/xorg/modules/drivers/vboxvideo_drv.so
	install -m 644 out/bin/additions/vboxmouse_drv_14.so debian/$(uname)/usr/lib/xorg/modules/input/vboxmouse_drv.so
	install -m 755 out/bin/additions/mountvboxsf debian/$(uname)/sbin/mount.vboxsf

	dh_install

	# These files have incorrect permissions, fixing it.
	chmod 755 debian/$(uname)/usr/lib/virtualbox/x11config.pl
	chmod 755 debian/$(sname)/usr/lib/virtualbox/VBox.sh
	chmod 755 debian/$(psource)/usr/src/modules/$(sname)/debian/rules
	chmod 755 debian/$(gsource)/usr/src/modules/$(gname)/debian/rules

	# Create .tar.bz2 for virtualbox*source
	cd debian/$(psource)/usr/src && \
		tar -cjf $(sname).tar.bz2 modules && \
		rm -rf modules
	cd debian/$(gsource)/usr/src && \
		tar -cjf $(gname).tar.bz2 modules && \
		rm -rf modules

binary-arch: build install
	dh_testdir -a
	dh_testroot -a
	dh_installchangelogs -a
	dh_installdocs -a
	dh_installmenu -a
	dh_link -a
	dh_strip -a --dbg-package=$(sname)-dbg
	rm -r debian/$(sname)-dbg/usr/lib/debug/usr/sbin debian/$(sname)-dbg/usr/lib/debug/sbin debian/$(sname)-dbg/usr/lib/debug/usr/lib/xorg
	dh_compress -a
	dh_fixperms -X=/usr/lib/virtualbox/VBox.sh -a
	dh_installudev -a
	dh_installinit -a
	dh_installdeb -a
	dh_shlibdeps -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

binary-indep: build install
	dh_testdir -i
	dh_testroot -i
	dh_installchangelogs -i
	dh_installdocs -i
	dh_link -i
	dh_compress -i
	dh_fixperms -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

binary: binary-arch binary-indep
.PHONY: patch unpatch \
	build clean binary-arch binary-indep binary install \
	binary-modules kdist kdist_configure kdist_image kdist_clean
