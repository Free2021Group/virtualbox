#!/usr/bin/make -f

include /usr/share/dpatch/dpatch.make

# Name of the source packages
psource:=virtualbox-ose-source
gsource:=virtualbox-ose-guest-source

# The short upstream name
sname:=virtualbox-ose
sxname:=virtualbox-ose-qt
gname:=virtualbox-ose-guest
uname:=virtualbox-ose-guest-utils
uxname:=virtualbox-ose-guest-x11

# Some defines needed for X
SERVERMINVERS = $(shell cat /usr/share/xserver-xorg/serverminver 2>/dev/null)
VIDEOABI = $(shell cat /usr/share/xserver-xorg/videoabiver 2>/dev/null)
INPUTABI = $(shell cat /usr/share/xserver-xorg/inputabiver 2>/dev/null)
SERVER_DEPENDS = xserver-xorg-core (>= $(SERVERMINVERS))
VIDDRIVER_PROVIDES = xserver-xorg-video-$(VIDEOABI)
INPDRIVER_PROVIDES = xserver-xorg-input-$(INPUTABI)

MAKE:=kmk

upstreamversion := $(shell dpkg-parsechangelog | sed -n 's/^Version: *\([^-]\+\)-.\+/\1/p')

DEB_HOST_ARCH ?= $(shell dpkg-architecture -qDEB_HOST_ARCH)

# Generate README.Debian as text/html ...
debian/README.Debian.html: debian/virtualbox-ose.files/README.Debian.xml
	xsltproc --nonet --stringparam section.autolabel 1 \
	    -o $@ \
	    /usr/share/xml/docbook/stylesheet/nwalsh/html/docbook.xsl \
	    $<

# ... and text/plain
debian/virtualbox-ose.README.Debian: debian/README.Debian.html
	chmod 755 debian/lynx-dump-postprocess
	export LC_ALL=C; lynx -force_html -dump $< | ./debian/lynx-dump-postprocess > $@.tmp
	mv $@.tmp $@

out/env.sh: patch-stamp
	dh_testdir
	mkdir -p out
	./configure \
	    --ose \
	    --odir=$(abspath out) \
	    --with-linux="/usr" \
	    --disable-kmods \
	    --enable-webservice

build: build-stamp
build-stamp: out/env.sh
	dh_testdir
	# Building package
	. out/env.sh && $(MAKE) \
	    AUTOCFG=$(abspath out/AutoConfig.kmk) \
	    LOCALCFG=$(abspath debian/LocalConfig.kmk) \
	    PATH_OUT=$(abspath out) \
	    TOOL_YASM_AS=yasm \
	    VBOX_WITH_REGISTRATION_REQUEST= \
	    VBOX_WITH_UPDATE_REQUEST= \
	    $(if $(DH_VERBOSE),KBUILD_VERBOSE=2,)
	touch $@

clean: unpatch
	dh_testdir
	dh_testroot
	# Cleaning package
	rm -rf out
	rm -f build-stamp
	rm -f debian/virtualbox-ose.README.Debian debian/README.Debian.html
	rm -f debian/$(gsource).files/dkms.conf
	rm -f debian/$(psource).install
	rm -f debian/$(gsource).install
	rm -f debian/$(psource).dirs
	rm -f debian/$(gsource).dirs
	rm -f debian/$(gsource).links

	find . -name "*.pyc" -exec rm -f {} \;
	dh_clean

#Rebuild the orig.tar.gz
dfsg-free: clean
	rm -rf ./kBuild
	rm -rf ./tools
	rm -rf ./src/VBox/Additions/os2
	rm -rf ./src/VBox/Additions/WINNT
	rm -f ./src/VBox/HostDrivers/Support/darwin/load.sh
	rm -f ./include/VBox/VBoxGuest.inc
	rm -f ./include/VBox/VBoxGuest16.h
	rm -f ./include/VBox/VBoxGuest.mac
	rm -f ./src/libs/xpcom18a4/xpcom/MoreFiles/FSCopyObject.c
	rm -f ./src/libs/xpcom18a4/xpcom/MoreFiles/FSCopyObject.h
	rm -rf ./src/libs/libpng*
	rm -rf ./src/libs/libxml2*
	rm -rf ./src/libs/libxslt*
	rm -rf ./src/libs/zlib*
	rm -rf ./src/VBox/Additions/linux/selinux-fedora
	find src/VBox/Additions/x11/x11include -mindepth 1 -maxdepth 1 \
		-type d -not -name '*mesa-*' | xargs rm -rf
	cd ..; mv $(CURDIR) virtualbox-ose-$(upstreamversion)-dfsg; \
	    tar --exclude .svn --exclude '.git*' --exclude debian \
	        -czf virtualbox-ose_$(upstreamversion)-dfsg.orig.tar.gz \
	        virtualbox-ose-$(upstreamversion)-dfsg

# install: DH_OPTIONS=
install: build debian/virtualbox-ose.README.Debian debian/README.Debian.html
	dh_testdir
	dh_testroot
	dh_clean -k

	sed -e 's/CVERSION/$(upstreamversion)/g' < debian/$(gsource).dirs.in > debian/$(gsource).dirs
	sed -e 's/CVERSION/$(upstreamversion)/g' < debian/$(psource).dirs.in > debian/$(psource).dirs
	sed -e 's/CVERSION/$(upstreamversion)/g' < debian/$(gsource).links.in > debian/$(gsource).links

	dh_installdirs

	# Create DKMS control files
	sed -e 's/CVERSION/$(upstreamversion)/g' < debian/$(psource).files/dkms.conf.vboxdrv.in > debian/$(psource)/usr/src/vboxdrv-$(upstreamversion)/dkms.conf
	sed -e 's/CVERSION/$(upstreamversion)/g' < debian/$(psource).files/dkms.conf.vboxnetflt.in > debian/$(psource)/usr/src/vboxnetflt-$(upstreamversion)/dkms.conf
	sed -e 's/CVERSION/$(upstreamversion)/g' < debian/$(psource).files/dkms.conf.vboxnetadp.in > debian/$(psource)/usr/src/vboxnetadp-$(upstreamversion)/dkms.conf
	sed -e 's/CVERSION/$(upstreamversion)/g' < debian/$(gsource).files/dkms.conf.in > debian/$(gsource).files/dkms.conf

	#Build install files for the dkms'ified sources
	sed -e 's/CVERSION/$(upstreamversion)/g' < debian/$(psource).install.in > debian/$(psource).install
	sed -e 's/CVERSION/$(upstreamversion)/g' < debian/$(gsource).install.in > debian/$(gsource).install

	export VBOX_INSTALL_PATH=/usr/lib/virtualbox && \
	    cd out/bin/sdk/installer && \
	    python ./vboxapisetup.py install --root $(CURDIR)/debian/virtualbox-ose
	# Install helper scripts for vbox* interfaces
	dh_installifupdown -p$(sname)

serverabi: install
ifeq ($(SERVERMINVERS),)
	@echo error: xserver-xorg-dev needs to be installed
	@exit 1
else
	echo "xserver:Depends=$(SERVER_DEPENDS)" >> debian/$(uxname).substvars
	echo "xviddriver:Provides=$(VIDDRIVER_PROVIDES)" >> debian/$(uxname).substvars
	echo "xinpdriver:Provides=$(INPDRIVER_PROVIDES)" >> debian/$(uxname).substvars
endif

binary-arch: build install serverabi
	dh_testdir -s
	dh_testroot -s
	dh_installchangelogs -s
	dh_installdocs -s
	dh_installmenu -s
	dh_install -s
	-chmod 644 debian/$(sname)/usr/lib/virtualbox/sdk/bindings/xpcom/python/xpcom/*.py
	-chmod 644 debian/$(sname)/usr/lib/virtualbox/sdk/bindings/xpcom/python/xpcom/server/*.py
	-chmod 644 debian/$(sname)/usr/lib/virtualbox/sdk/bindings/xpcom/python/xpcom/client/*.py
	-chmod 755 debian/$(uxname)/usr/share/virtualbox/x11config.pl
	-install -m 755 src/VBox/Additions/x11/Installer/VBoxRandR.sh debian/$(uxname)/usr/bin/VBoxRandR
	-chrpath -d debian/$(uxname)/usr/bin/VBoxClient
	-chrpath -d debian/$(uxname)/usr/lib/xorg/modules/drivers/vboxvideo_drv.so
	-chrpath -d debian/$(uxname)/usr/lib/xorg/modules/input/vboxmouse_drv.so
	-install -m 755 out/bin/additions/mountvboxsf debian/$(uname)/sbin/mount.vboxsf
	-chrpath -d debian/$(uname)/sbin/mount.vboxsf
	-chrpath -d debian/$(uname)/usr/sbin/VBoxService
	-chrpath -d debian/$(uname)/usr/sbin/VBoxControl
	-chmod 755 debian/$(sname)/usr/share/virtualbox/VBox.sh
	dh_pycentral -pvirtualbox-ose
	dh_strip -s --dbg-package=$(sname)-dbg
	dh_link -s
	dh_compress -s
	dh_fixperms -s
	chmod +s debian/$(sname)/usr/lib/virtualbox/VBoxSDL
	chmod +s debian/$(sname)/usr/lib/virtualbox/VBoxHeadless
	chmod +s debian/$(sname)/usr/lib/virtualbox/VBoxNetDHCP
	chmod +s debian/$(sname)/usr/lib/virtualbox/VBoxNetAdpCtl
	chmod +s debian/$(sxname)/usr/lib/virtualbox/VirtualBox
	dh_installudev -s
	dh_installinit -s --no-start
	dh_installdeb -s
	dh_shlibdeps -s
	dh_gencontrol -s
	dh_md5sums -s
	dh_builddeb -s

binary-indep: build install
	dh_testdir -i
	dh_testroot -i
	dh_installchangelogs -i
	dh_installdocs -i
	dh_install -i
	dh_link -i
	dh_compress -i
	dh_fixperms -i
	# Need to be executable for DKMS:
	chmod +x debian/$(psource)/usr/src/vboxdrv-$(upstreamversion)/do_Module.symvers
	chmod +x debian/$(psource)/usr/src/vboxnetflt-$(upstreamversion)/do_Module.symvers
	chmod +x debian/$(psource)/usr/src/vboxnetadp-$(upstreamversion)/do_Module.symvers
	dh_installudev -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

binary: binary-arch binary-indep
.PHONY: patch unpatch serverabi \
	build clean binary-arch binary-indep binary install \
	binary-modules kdist kdist_configure kdist_image kdist_clean
